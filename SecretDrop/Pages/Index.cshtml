@page
@model IndexModel
@{
    ViewData["Title"] = "Новый секрет";
}

<div class="animate-fade-in">
    <!-- Main Card -->
    <div class="relative bg-zinc-900 border border-emerald-500/20 w-full rounded shadow-[0_0_40px_rgba(16,185,129,0.05)] overflow-hidden">

        <!-- Card Header -->
        <div class="flex items-center justify-between p-4 border-b border-zinc-800 bg-zinc-950">
            <h2 class="text-emerald-500 font-mono font-bold tracking-widest flex items-center gap-2 text-sm">
                <span class="animate-pulse">_</span>СОЗДАНИЕ_СЕКРЕТА
            </h2>
            <div class="text-zinc-600 font-mono text-[10px]">ШИФРОВАНИЕ НА УСТРОЙСТВЕ</div>
        </div>

        <!-- Body -->
        <div class="p-6 md:p-8 space-y-8">

            <!-- Tabs -->
            <div class="grid grid-cols-3 gap-1 p-1 bg-zinc-950 rounded border border-zinc-800">
                <button id="tab-file" onclick="switchTab('file')" class="py-2 text-[10px] font-mono font-bold text-zinc-500 hover:text-zinc-300 transition uppercase rounded-sm active-tab">
                    <i class="bi bi-file-earmark-lock mr-2"></i>ФАЙЛ
                </button>
                <button id="tab-text" onclick="switchTab('text')" class="py-2 text-[10px] font-mono font-bold text-zinc-500 hover:text-zinc-300 transition uppercase rounded-sm">
                    <i class="bi bi-chat-text mr-2"></i>ТЕКСТ
                </button>
                <button id="tab-image" onclick="switchTab('image')" class="py-2 text-[10px] font-mono font-bold text-zinc-500 hover:text-zinc-300 transition uppercase rounded-sm">
                    <i class="bi bi-card-image mr-2"></i>ФОТО
                </button>
            </div>

            <!-- FILE PANE -->
            <div id="pane-file" class="mt-6 transition-all">
                <div class="border-2 border-dashed border-zinc-800 rounded bg-zinc-950/30 p-10 cursor-pointer transition-all hover:border-emerald-500/30 hover:bg-emerald-900/5 group" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center group-hover:border-emerald-500/50 group-hover:bg-emerald-900/10 transition duration-300">
                            <i class="bi bi-cloud-upload text-2xl text-zinc-500 group-hover:text-emerald-400 transition"></i>
                        </div>
                        <h5 class="font-mono text-zinc-300 text-sm font-bold">ПЕРЕТАЩИТЕ ФАЙЛ СЮДА</h5>
                        <p class="text-[10px] text-zinc-500 font-mono mt-2 uppercase" id="fileNameDisplay">МАКС. РАЗМЕР: 5 ГБ</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" onchange="updateFileName(this)">
                </div>
            </div>

            <!-- TEXT PANE -->
            <div id="pane-text" class="mt-6 hidden">
                <label class="block text-[10px] font-mono text-zinc-500 uppercase tracking-wider mb-2">ВАШЕ СООБЩЕНИЕ</label>
                <textarea id="textInput" class="bg-zinc-950 border border-zinc-700 text-zinc-200 px-4 py-3 text-sm font-mono rounded w-full h-48 resize-none focus:outline-none focus:border-emerald-500/50 placeholder-zinc-700 transition-all" placeholder="// Введите секретный текст..."></textarea>
            </div>

            <!-- IMAGE PANE -->
            <div id="pane-image" class="mt-6 hidden">
                <div class="border-2 border-dashed border-zinc-800 rounded bg-zinc-950/30 p-10 cursor-pointer transition-all hover:border-emerald-500/30 hover:bg-emerald-900/5 group min-h-[12rem] flex items-center justify-center" id="imageDropZone" onclick="document.getElementById('imageInput').click()">
                    <div id="imagePreviewPlaceholder" class="text-center">
                        <i class="bi bi-image text-4xl text-zinc-700 group-hover:text-emerald-500/50 transition duration-300 mb-3 block"></i>
                        <h5 class="font-mono text-zinc-500 text-xs">ВСТАВЬТЕ СКРИНШОТ (CTRL+V)</h5>
                    </div>
                    <img id="imagePreview" class="max-h-64 max-w-full object-contain rounded hidden shadow-lg border border-zinc-700/50" />
                    <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="handleImageSelect(this)">
                </div>
            </div>

            <!-- Settings Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-zinc-800 pt-6">
                <div>
                    <label class="block text-[10px] font-mono text-zinc-500 uppercase tracking-wider mb-2 font-bold">СРОК ЖИЗНИ (TTL)</label>
                    <div class="relative">
                        <select id="ttl" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-200 px-4 py-3 text-sm font-mono rounded appearance-none focus:outline-none focus:border-emerald-500/50 cursor-pointer hover:border-zinc-600 transition-colors">
                            <option value="60">1 ЧАС</option>
                            <option value="1440" selected>24 ЧАСА</option>
                            <option value="4320">3 ДНЯ</option>
                            <option value="10080">7 ДНЕЙ</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-zinc-500">
                            <i class="bi bi-chevron-down text-[10px]"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-mono text-zinc-500 uppercase tracking-wider mb-2 font-bold">ЛИМИТ СКАЧИВАНИЙ</label>
                    <div class="relative">
                        <select id="limit" class="w-full bg-zinc-950 border border-zinc-700 text-zinc-200 px-4 py-3 text-sm font-mono rounded appearance-none focus:outline-none focus:border-emerald-500/50 cursor-pointer hover:border-zinc-600 transition-colors">
                            <option value="1">1 РАЗ (СЖЕЧЬ)</option>
                            <option value="2">2 РАЗА</option>
                            <option value="5">5 РАЗ</option>
                            <option value="100">100 РАЗ</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-zinc-500">
                            <i class="bi bi-chevron-down text-[10px]"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Toggle -->
            <div class="bg-zinc-950/50 p-4 rounded border border-zinc-800">
                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="usePassword" class="sr-only peer" onchange="togglePassword(this)">
                            <div class="w-9 h-5 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-600"></div>
                        </div>
                        <span class="text-xs font-mono text-zinc-400 uppercase tracking-wider font-bold">Защитить паролем</span>
                    </label>
                </div>
                <div id="passwordBlock" class="hidden mt-4 transition-all duration-300">
                    <input type="password" id="senderPassword" class="bg-zinc-950 border border-zinc-700 text-zinc-200 px-4 py-3 text-sm font-mono rounded focus:outline-none focus:border-emerald-500/50 w-full text-center tracking-[0.3em] text-emerald-400 font-bold" placeholder="••••••" autocomplete="new-password">
                    <p class="text-[9px] text-amber-500/60 font-mono mt-2 text-center border border-dashed border-amber-900/30 p-1 rounded">
                        <i class="bi bi-exclamation-triangle mr-1"></i> ВНИМАНИЕ: ПРИ УТЕРЕ ПАРОЛЯ ДАННЫЕ БУДУТ НЕДОСТУПНЫ
                    </p>
                </div>
            </div>

            <!-- Action Button -->
            <button onclick="startUpload()" id="btnSend" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-black font-mono text-sm font-bold transition rounded shadow-[0_0_20px_rgba(16,185,129,0.2)] flex items-center justify-center gap-2 group">
                <i class="bi bi-shield-lock-fill group-hover:scale-110 transition"></i>
                <span>ЗАШИФРОВАТЬ И ПОЛУЧИТЬ ССЫЛКУ</span>
            </button>

            <!-- Progress Bar -->
            <div id="progressArea" class="hidden">
                <div class="flex justify-between text-[10px] font-mono text-zinc-400 mb-2">
                    <span class="animate-pulse">ШИФРОВАНИЕ И ЗАГРУЗКА...</span>
                    <span id="progressText" class="text-emerald-500">0%</span>
                </div>
                <div class="h-1 w-full bg-zinc-800 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-emerald-500 transition-all duration-100 ease-out shadow-[0_0_10px_#10b981]" style="width: 0%"></div>
                </div>
            </div>

            <!-- Result Area -->
            <div id="resultArea" class="hidden animate-fade-in pt-4 border-t border-zinc-800">
                <div class="bg-zinc-950 border border-emerald-500/30 p-6 rounded text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-500 to-transparent opacity-50"></div>

                    <div class="text-emerald-500 text-4xl mb-3"><i class="bi bi-check-circle-fill"></i></div>
                    <h5 class="text-zinc-200 font-mono text-sm font-bold mb-4 tracking-widest">СЕКРЕТ ГОТОВ</h5>

                    <div class="flex items-center gap-2 mb-6">
                        <input type="text" id="resultLink" class="bg-zinc-950 border border-zinc-700 px-4 py-3 text-sm font-mono rounded focus:outline-none w-full text-center text-emerald-400 font-bold text-xs shadow-inner" readonly>
                        <button onclick="copyLink()" id="btnCopy" class="p-2.5 border border-zinc-700 bg-zinc-800 hover:border-emerald-500 text-emerald-500 rounded transition hover:bg-emerald-900/20" title="Копировать">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>

                    <button class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 mb-4 hover:underline transition" type="button" onclick="toggleQr()">
                        [ ПОКАЗАТЬ QR-КОД ]
                    </button>

                    <div id="qrCollapse" class="hidden flex justify-center mb-4">
                        <div id="qrcode-container" class="p-3 bg-white rounded cursor-pointer hover:opacity-90 transition shadow-lg" onclick="copyQrImage()" title="Нажмите, чтобы скопировать картинку">
                            <div id="qrcode"></div>
                        </div>
                    </div>

                    <div class="text-[9px] text-zinc-600 font-mono">
                        ССЫЛКА ДЕЙСТВИТЕЛЬНА В ПРЕДЕЛАХ ЛИМИТА ИЛИ ТАЙМЕРА.
                    </div>
                </div>
                <button onclick="location.reload()" class="w-full mt-6 text-xs font-mono text-zinc-500 hover:text-emerald-500 transition border border-transparent hover:border-zinc-800 p-2 rounded">
                    [ СОЗДАТЬ НОВЫЙ ]
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    let currentMode = 'file';
    let selectedImageBlob = null;
    const CHUNK_SIZE = 4 * 1024 * 1024;

    function switchTab(mode) {
        currentMode = mode;
        ['file', 'text', 'image'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const pane = document.getElementById(`pane-${t}`);

            if (mode === t) {
                btn.classList.add('active-tab');
                pane.classList.remove('hidden');
            } else {
                btn.classList.remove('active-tab');
                pane.classList.add('hidden');
            }
        });
    }

    function toggleQr() {
        document.getElementById('qrCollapse').classList.toggle('hidden');
    }

    function togglePassword(chk) {
        const block = document.getElementById('passwordBlock');
        const passInput = document.getElementById('senderPassword');
        if (chk.checked) {
            block.classList.remove('hidden');
            setTimeout(() => passInput.focus(), 50);
        } else {
            block.classList.add('hidden');
            passInput.value = '';
        }
    }

    function copyLink() {
        const copyText = document.getElementById("resultLink");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        const btn = document.getElementById('btnCopy');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-lg"></i>';
        btn.classList.add('text-emerald-400', 'border-emerald-400');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('text-emerald-400', 'border-emerald-400');
        }, 2000);
    }

    function updateFileName(input) {
        const display = document.getElementById('fileNameDisplay');
        if (input.files && input.files[0]) {
            display.innerText = "ВЫБРАН: " + input.files[0].name;
            display.classList.add('text-emerald-400', 'font-bold');
        } else {
            display.innerText = "МАКС. РАЗМЕР: 5 ГБ";
            display.classList.remove('text-emerald-400', 'font-bold');
        }
    }

    function handleImageSelect(input) {
        if (input.files && input.files[0]) {
            processImageFile(input.files[0]);
        }
    }

    function processImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert("Это не картинка!");
            return;
        }
        selectedImageBlob = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreviewPlaceholder').classList.add('hidden');
            const img = document.getElementById('imagePreview');
            img.src = e.target.result;
            img.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    document.addEventListener('paste', function(e) {
        if (currentMode !== 'image') return;
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const blob = item.getAsFile();
                processImageFile(blob);
                e.preventDefault();
                break;
            }
        }
    });

    // Drag & Drop styling
    const dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        dropZone.classList.remove('dragover');
        const dt = e.dataTransfer;
        document.getElementById('fileInput').files = dt.files;
        updateFileName(document.getElementById('fileInput'));
    });

    // --- Main Logic ---
    async function startUpload() {
        const btn = document.getElementById('btnSend');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressArea = document.getElementById('progressArea');
        document.getElementById('resultArea').classList.add('hidden');

        let blobToSend = null;
        let filename = 'secret';
        let type = 'file';

        try {
            if (currentMode === 'file') {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files[0]) { alert("Выберите файл!"); return; }
                blobToSend = fileInput.files[0];
                filename = blobToSend.name;
                type = 'file';
            }
            else if (currentMode === 'image') {
                if (!selectedImageBlob) { alert("Нет изображения для отправки!"); return; }
                blobToSend = selectedImageBlob;
                filename = selectedImageBlob.name || 'image.png';
                type = 'image';
            }
            else {
                const textVal = document.getElementById('textInput').value;
                if (!textVal) { alert("Введите текст!"); return; }
                blobToSend = new Blob([textVal], { type: 'text/plain' });
                filename = 'secure_message.txt';
                type = 'message';
            }

            const usePass = document.getElementById('usePassword').checked;
            const password = document.getElementById('senderPassword').value;
            if (usePass && !password) { alert("Введите пароль!"); return; }

            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin mr-2">/</span> ШИФРОВАНИЕ...';
            progressArea.classList.remove('hidden');
            updateProgress(0);

            const fileKey = await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
            const fileIvBase = window.crypto.getRandomValues(new Uint8Array(12));
            let urlHashKey = null; let passwordSalt = null; let wrappedKeyBlob = null;

            if (usePass) {
                const urlKey = await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                passwordSalt = toBase64(salt);
                const passKey = await deriveKeyFromPassword(password, salt);
                const rawFileKey = await window.crypto.subtle.exportKey("raw", fileKey);
                const innerIv = window.crypto.getRandomValues(new Uint8Array(12));
                const innerEncrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: innerIv }, passKey, rawFileKey);
                const outerIv = window.crypto.getRandomValues(new Uint8Array(12));
                const innerBlob = new Uint8Array(innerIv.length + innerEncrypted.byteLength);
                innerBlob.set(innerIv); innerBlob.set(new Uint8Array(innerEncrypted), 12);
                const outerEncrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: outerIv }, urlKey, innerBlob);
                const finalBlob = new Uint8Array(outerIv.length + outerEncrypted.byteLength);
                finalBlob.set(outerIv); finalBlob.set(new Uint8Array(outerEncrypted), 12);
                wrappedKeyBlob = toBase64(finalBlob);
                const exportedUrlKey = await window.crypto.subtle.exportKey("jwk", urlKey);
                urlHashKey = exportedUrlKey.k;
            } else {
                const jwk = await window.crypto.subtle.exportKey("jwk", fileKey);
                urlHashKey = jwk.k;
            }

            const meta = JSON.stringify({ filename: filename, size: blobToSend.size, iv: toBase64(fileIvBase), type: type });
            const initResp = await fetch('?handler=Init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    meta: meta,
                    ttl: document.getElementById('ttl').value,
                    limit: document.getElementById('limit').value,
                    passwordSalt: passwordSalt,
                    wrappedKey: wrappedKeyBlob
                })
            });

            if (!initResp.ok) throw new Error("ОШИБКА ИНИЦИАЛИЗАЦИИ: " + initResp.status);
            const { id } = await initResp.json();

            let offset = 0;
            let chunkIndex = 0;
            while (offset < blobToSend.size) {
                const chunkBlob = blobToSend.slice(offset, offset + CHUNK_SIZE);
                const chunkBuffer = await chunkBlob.arrayBuffer();
                const chunkIv = deriveIv(fileIvBase, chunkIndex);
                const encryptedChunk = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: chunkIv }, fileKey, chunkBuffer);
                const chunkResp = await fetch(`?handler=Chunk&id=${id}`, { method: 'POST', body: encryptedChunk });
                if (!chunkResp.ok) throw new Error("ОШИБКА ЗАГРУЗКИ ЧАСТИ");
                offset += CHUNK_SIZE;
                chunkIndex++;
                updateProgress(Math.min(100, Math.round((offset / blobToSend.size) * 100)));
            }

            const link = `${window.location.origin}/view/${id}#${urlHashKey}`;
            document.getElementById('resultLink').value = link;
            document.getElementById('resultArea').classList.remove('hidden');
            if (typeof generateQR === "function") generateQR(link);

        } catch (err) {
            console.error(err);
            alert("ОШИБКА: " + err.message);
            if(progressBar) progressBar.classList.add('bg-red-500');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-shield-check-fill"></i> ЗАШИФРОВАТЬ И ОТПРАВИТЬ';
            progressArea.classList.add('hidden');
            if(progressBar) progressBar.classList.remove('bg-red-500');
        }
    }

    function updateProgress(percent) {
        const bar = document.getElementById('progressBar');
        const txt = document.getElementById('progressText');
        if(bar) bar.style.width = percent + '%';
        if(txt) txt.innerText = percent + '%';
    }

    async function deriveKeyFromPassword(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
        return await window.crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
        );
    }
    function deriveIv(baseIv, counter) {
        const iv = new Uint8Array(baseIv);
        const view = new DataView(iv.buffer);
        const currentLast4 = view.getUint32(8, true);
        view.setUint32(8, currentLast4 ^ counter, true);
        return iv;
    }
    function toBase64(u8) { return btoa(String.fromCharCode.apply(null, u8)); }
    function generateQR(text) {
        const container = document.getElementById("qrcode");
        container.innerHTML = "";
        new QRCode(container, {
            text: text, width: 128, height: 128,
            colorDark : "#000000", colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.M
        });
    }
    function copyQrImage() {
        const container = document.getElementById("qrcode");
        const canvas = container.querySelector("canvas");
        if (!canvas) return;
        canvas.toBlob(async function(blob) {
            try {
                const item = new ClipboardItem({ "image/png": blob });
                await navigator.clipboard.write([item]);
                alert("QR-КОД СКОПИРОВАН");
            } catch (e) { alert("ОШИБКА КОПИРОВАНИЯ (НУЖЕН HTTPS)"); }
        });
    }
</script>